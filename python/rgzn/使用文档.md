# 异步智能助理使用文档

## 项目简介

这是一个基于 Python 的异步智能助理，支持：
- 多 LLM Provider 管理和自动轮换
- 异步 TTS 语音合成
- 弱网模式自动适应
- 带宽管理和健康监控
- 交互式和单次命令模式

## 安装依赖

```bash
pip install g4f edge-tts pygame
```

可选依赖：
- `pygame` - 用于流式 TTS 播放（如果不安装会回退到文件播放）

## 快速开始

### 1. 交互模式

直接运行程序进入交互模式：

```bash
python main_improved.py
```

或使用详细日志：

```bash
python main_improved.py --verbose
```

### 2. 单次命令模式

执行单次对话后退出：

```bash
python main_improved.py --prompt "你好，介绍一下自己"
```

带 TTS 的单次命令：

```bash
python main_improved.py --prompt "讲个笑话" --tts-immediate
```

## 命令行参数

### 基本参数

- `--prompt TEXT` - 单次提问模式，处理后保持运行等待 TTS 完成
- `--verbose` - 启用详细调试日志

### TTS 参数

- `--tts-voice VOICE` - TTS 语音（默认：zh-CN-XiaoxiaoNeural）
- `--tts-dir PATH` - TTS 输出目录（默认：tts_output）
- `--tts-rate RATE` - TTS 语速（默认：+0%，范围：-50% 到 +100%）
- `--tts-volume VOLUME` - TTS 音量（默认：+0%）
- `--tts-immediate` - 配合 --prompt 在输出后立即进行 TTS
- `--no-tts-play` - 生成语音时不自动播放
- `--tts-streaming` - 启用流式 TTS 生成和播放

### 示例

```bash
# 使用不同的语音
python main_improved.py --tts-voice zh-CN-YunxiNeural

# 调整语速和音量
python main_improved.py --tts-rate "+50%" --tts-volume "+20%"

# 启用流式 TTS
python main_improved.py --tts-streaming

# 生成但不播放
python main_improved.py --no-tts-play
```

## 交互模式命令

在交互模式下，支持以下命令：

### 1. 普通对话

直接输入文本进行对话：

```
您: 你好
AI: 你好！有什么我可以帮助你的吗？
```

### 2. TTS 命令

使用 `tts:` 前缀将文本转换为语音：

```
您: tts:这是一段测试文本
[TTS] 已生成语音: tts_output/tts_1234567890.mp3
```

### 3. 退出程序

输入 `exit` 退出：

```
您: exit
[提示] 正在退出...
```

## 功能特性

### 1. Provider 管理

#### 自动测速和选择

程序启动时会自动测试所有 Provider 的响应速度，选择最快的：

```
正在测速 provider...

  Yqcloud: 1.23s
  TeachAnything: 2.45s
  PollinationsAI: 1.89s

[OK] 已选择最快: Yqcloud
```

#### 自动轮换

当 Provider 失败时，自动切换到下一个：

```
[Provider] 当前使用: Yqcloud
[错误] Provider unavailable
[Provider] 已轮换: Yqcloud -> TeachAnything
```

#### 带宽管理

自动监控每个 Provider 的 Token 使用，超限自动切换：

```
[提示] 已自动切换 Provider 以避免带宽限制
```

### 2. 弱网模式

#### 自动启用

当检测到网络问题时，自动启用弱网模式：

```
[弱网] 当前处于弱网模式，已限制输出长度并关闭 TTS
```

弱网模式特性：
- 限制输出长度（300 字符）
- 禁用 TTS
- 切换到稳定 Provider
- 暂存失败的任务

#### 自动恢复

连续成功请求后自动退出弱网模式：

```
[INFO] 弱网模式结束：连续成功请求 (持续时间: 45.2 秒)
[verbose] 网络恢复，重新排入 3 个任务
```

### 3. TTS 功能

#### 异步生成

TTS 在后台异步生成，不阻塞对话：

```
您: 讲个笑话
AI: 为什么程序员总是混淆圣诞节和万圣节？因为 Oct 31 == Dec 25！
[TTS] 已生成语音: tts_output/tts_1234567890.mp3
```

#### 流式播放

启用流式模式可以边生成边播放：

```bash
python main_improved.py --tts-streaming
```

```
[TTS] 流式语音播放完成
```

#### 失败重试

TTS 失败时自动重试，网络恢复后继续：

```
[TTS 错误] 合成失败
[verbose] TTS 任务已入队待稍后重试（总计 1 个）
```

### 4. 任务调度

#### 统一队列

所有任务（对话、TTS）使用统一的异步队列：

```
[verbose] 开始处理对话任务（来源: cli）
[verbose] 开始处理 TTS 任务（长度 50 字符）
```

#### 自动重试

失败的任务自动重试（最多 3 次）：

```
[verbose] 任务重试 (1/3)
```

#### 延迟执行

弱网模式下的任务会被延迟，网络恢复后自动执行：

```
[弱网] TTS 任务已暂存，稍后自动继续
[verbose] 网络恢复，重新排入 2 个任务
```

## 高级配置

### 环境变量

- `LLM_MODE` - LLM 模式（默认：remote）
  - `remote` - 使用远程 Provider
  - `local` - 本地模型（未实现）
  - `edge` - 边缘推理（未实现）

### Provider 配置

编辑 `main_improved.py` 中的配置：

```python
PROVIDER_NAMES = [
    "Yqcloud",
    "TeachAnything",
    "PollinationsAI",
]
RESTRICTED_PROVIDER_NAMES = {"Mintlify"}
STABLE_PROVIDER_NAME = "Yqcloud"
```

### 弱网模式配置

```python
WEAK_MODE_CHAR_LIMIT = 300  # 弱网模式下的字符限制
```

### 带宽策略

编辑 `providers_improved.py`：

```python
GLOBAL_BANDWIDTH_POLICY = BandwidthPolicy(limit_per_minute=4000)
```

## 测试

运行测试脚本：

```bash
python test_improved.py
```

测试内容：
- Provider 管理器功能
- TTS 合成功能
- 主流程集成

## 故障排除

### 1. TTS 失败

**问题**：TTS 合成失败

**解决方案**：
```bash
# 安装 edge-tts
pip install edge-tts

# 检查网络连接
ping www.microsoft.com
```

### 2. Provider 不可用

**问题**：所有 Provider 都失败

**解决方案**：
- 检查网络连接
- 等待一段时间后重试
- 程序会自动进入弱网模式

### 3. 流式播放失败

**问题**：流式 TTS 播放失败

**解决方案**：
```bash
# 安装 pygame
pip install pygame

# 或使用非流式模式
python main_improved.py  # 不加 --tts-streaming
```

### 4. 程序不退出

**问题**：输入 exit 后程序不退出

**解决方案**：
- 等待当前任务完成
- 使用 Ctrl+C 强制退出
- 检查是否有待处理的 TTS 任务

## 最佳实践

### 1. 日常使用

```bash
# 推荐配置
python main_improved.py --verbose
```

### 2. 快速问答

```bash
# 单次问答
python main_improved.py --prompt "你的问题"
```

### 3. 语音输出

```bash
# 带语音的问答
python main_improved.py --prompt "讲个故事" --tts-immediate --tts-streaming
```

### 4. 调试模式

```bash
# 详细日志
python main_improved.py --verbose
```

## 性能优化

### 1. Provider 选择

- 程序会自动选择最快的 Provider
- 失败时自动轮换
- 带宽超限时自动切换

### 2. 异步处理

- 所有 I/O 操作都是异步的
- TTS 在后台生成，不阻塞对话
- 多任务并发处理

### 3. 资源管理

- 自动清理临时文件
- 合理的重试策略
- 弱网模式下限制资源使用

## 更新日志

### v2.0 (改进版)

- ✅ 优化 Provider 管理系统
- ✅ 增强弱网模式
- ✅ 改进 TTS 流式播放
- ✅ 完善错误处理
- ✅ 添加健康监控
- ✅ 优化任务调度

### v1.0 (原始版)

- 基本的 Provider 管理
- TTS 功能
- 交互模式

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License
